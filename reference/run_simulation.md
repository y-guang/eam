# Run a simulation with specified configuration

This function runs a complete simulation based on the provided
eam_simulation_config object, which is generated by the
[`new_simulation_config`](https://y-guang.github.io/eam/reference/new_simulation_config.md)
function.

## Usage

``` r
run_simulation(config, output_dir = NULL)
```

## Arguments

- config:

  A eam_simulation_config object containing all simulation parameters,
  you should use
  [`new_simulation_config`](https://y-guang.github.io/eam/reference/new_simulation_config.md)
  to create one.

- output_dir:

  The directory to save out-of-core results (optional, will use temp
  directory if not provided)

## Value

A S3 object of class eam_simulation_output containing the output
information

## Details

This function uses an out-of-core approach to handle potentially large
simulation results. Instead of returning a data frame directly, it
persists the data to disk and returns an `eam_simulation_output` object
that contains metadata and file system paths.

To access the simulation data, use the following methods on the returned
object:

- `open_dataset()` - Returns an Arrow Dataset containing the simulation
  results, e.g. `sim_output$open_dataset()`

- `open_evaluated_conditions()` - Returns an Arrow Dataset containing
  the evaluated condition parameters, e.g.
  `sim_output$open_evaluated_conditions()`

Both methods return Arrow Dataset objects rather than data frames,
allowing for efficient querying and filtering before loading data into
memory. To convert to a data frame, use
[`dplyr::collect()`](https://dplyr.tidyverse.org/reference/compute.html)
or [`as.data.frame()`](https://rdrr.io/r/base/as.data.frame.html).

Throughout this package, the `eam_simulation_output` object is used as
the standard parameter for downstream analysis functions, rather than
passing Arrow objects or data frames directly.

For multi-item backends, at each discrete time point, only one item can
reach the threshold. The precision of this detection depends on the `dt`
parameter. This design choice was made for performance considerations.
For almost all experimental scenarios, it is negligible. But users
should be aware of this limitation, if it is critical, try to increase
the temporal resolution by reducing `dt`. For implementation details,
refer to the backend source code (`accumulate_evidence_*` functions).

## Examples

``` r
# Define formulas for the simulation
prior_formulas <- list(
  V ~ distributional::dist_uniform(0.1, 1.0),
  ndt ~ 0.3,
  noise_coef ~ 1
)

between_trial_formulas <- list()

item_formulas <- list(
  A_upper ~ 1,
  A_lower ~ -1,
  V ~ V
)

# Define noise factory
noise_factory <- function(context) {
  noise_coef <- context$noise_coef
  function(n, dt) {
    noise_coef * rnorm(n, mean = 0, sd = sqrt(dt))
  }
}

# Create configuration
config <- new_simulation_config(
  prior_formulas = prior_formulas,
  between_trial_formulas = between_trial_formulas,
  item_formulas = item_formulas,
  n_conditions = 10,
  n_trials_per_condition = 10,
  n_items = 5,
  max_reached = 5,
  max_t = 10,
  dt = 0.01,
  noise_mechanism = "add",
  noise_factory = noise_factory,
  model = "ddm",
  parallel = FALSE
)

# Run simulation
sim_output <- run_simulation(config)
#> Error in accumulate_evidence_ddm_2b(item_params$A_upper, item_params$A_lower,     item_params$V, Z, item_params$ndt, max_t, dt, max_reached,     noise_mechanism, noise_fun): could not find function "accumulate_evidence_ddm_2b"

# Access results
dataset <- sim_output$open_dataset()
#> Error: object 'sim_output' not found
dataset # an arrow dataset object
#> Error: object 'dataset' not found

# if you want to load it into memory, you can use:
df <- as.data.frame(dataset)
#> Error: object 'dataset' not found
head(df)
#>                                               
#> 1 function (x, df1, df2, ncp, log = FALSE)    
#> 2 {                                           
#> 3     if (missing(ncp))                       
#> 4         .Call(C_df, x, df1, df2, log)       
#> 5     else .Call(C_dnf, x, df1, df2, ncp, log)
#> 6 }                                           

# Access evaluated condition parameters
cond_dataset <- sim_output$open_evaluated_conditions()
#> Error: object 'sim_output' not found
df_cond <- as.data.frame(cond_dataset)
#> Error: object 'cond_dataset' not found
head(df_cond)
#> Error: object 'df_cond' not found
```
